<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JR Station Configuration Editor</title>
    <style>
        /* Base styles */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            line-height: 1.6;
            padding: 20px; 
        }

        /* Layout and containers */
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .top-panel, .editor-panel, .preview-panel {
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-panel {
            padding: 15px;
        }

        .editor-panel {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .bottom-panels {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .bottom-panels > div:first-child {
            flex: 0 0 auto;
            max-width: 335px;
        }

        .bottom-panels > div:last-child {
            flex: 1;
            min-width: 0;
        }

        .bottom-panels .editor-panel {
            padding: 12px;
            height: auto;
            display: flex;
            align-items: center;
        }

        /* Section styles */
        .editor-section {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 6px;
        }

        .editor-section + .editor-section {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }

        /* Typography */
        h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 0.9rem;
            margin: 0 0 8px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            width: 100%;
        }

        .preview-panel h3 {
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .bottom-panels h3 {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .line-config h3 {
            font-size: 0.85rem;
            margin: 0;
            white-space: nowrap;
        }

        /* Form elements */
        label {
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: #666;
            display: block;
        }

        input, select {
            padding: 4px 6px;
            font-size: 0.9rem;
            height: 28px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .bottom-panels select {
            height: 24px;
            padding: 2px 6px;
        }

        /* Grids and layouts */
        .config-grid, 
        .line-config-grid, 
        .station-config-grid {
            display: grid;
            gap: 8px;
            align-items: start;
        }

        .config-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .line-config-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .station-config-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .config-full, 
        .line-config-full, 
        .station-config-full {
            grid-column: 1 / -1;
        }

        /* Compact grid elements */
        .config-grid label {
            font-size: 0.75rem;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .config-grid input,
        .config-grid select {
            padding: 4px;
            height: 26px;
            font-size: 0.85rem;
            min-width: 0;
        }

        /* Color input groups */
        .color-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .color-input .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .color-input input[type="color"] {
            width: 40px;
            height: 28px;
            padding: 0;
            flex-shrink: 0;
        }

        .color-input input[type="text"] {
            flex: 1;
        }

        .config-grid .color-input input[type="color"] {
            width: 24px;
            height: 25px;
        }

        .line-config .color-input {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 100px;
            max-width: 180px;
        }

        .line-config .color-input label {
            width: 70px;
            white-space: nowrap;
        }

        .line-config input[type="color"] {
            width: 24px;
            height: 24px;
            padding: 0;
            flex-shrink: 0;
        }

        .line-config input[type="text"] {
            width: 85px;
            height: 24px;
            padding: 2px 4px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* Configuration sections */
        .line-config .config-grid {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: nowrap;
            min-width: 0;
            overflow: hidden;
        }

        .line-config .form-group {
            flex: 0 1 auto;
            width: 70px;
            min-width: 70px;
        }

        .line-config .color-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .config-file-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .config-file-input {
            display: block;
        }
        
        #configFilename {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .config-file-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            margin-left: auto;
            flex: 1;
        }

        .config-file-buttons .btn {
            flex: 1;
            min-width: 60px;
            padding: 4px 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Buttons */
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            flex: 0 1 auto;
            white-space: nowrap;
        }

        .btn:hover {
            background: #1976D2;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 0 8px;
            height: 28px;
            min-width: 28px;
            font-size: 14px;
        }

        .btn-group {
            margin-top: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: flex-start;
        }

        .form-group.config-full .btn {
            height: 28px;
            padding: 0 16px;
            align-self: flex-end;
        }

        .bottom-panels .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .bottom-panels .btn {
            flex: 1;
            min-width: 70px;
            padding: 4px 10px;
            white-space: nowrap;
        }

        .line-config .btn-group {
            display: flex;
            flex: 0 0 auto;
        }

        /* Name edit fields */
        .name-edit-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 120px;
        }

        .name-edit-field select,
        .name-edit-field input {
            margin-top: 2px;
            width: 100%;
        }

        .name-edit-group {
            display: flex;
            gap: 4px;
            align-items: flex-start;
            flex: 1;
            flex-wrap: wrap;
        }

        /* Navigation and selectors */
        .selector-with-nav {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .nav-buttons {
            display: flex;
            gap: 2px;
        }

        .selector-with-nav select {
            width: calc(100% - 64px);
        }

        /* Station Sign Preview Styles */
        .station-sign {
            background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 100%);
            padding: 15px 15px 0;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .station-content {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 60px;
        }

        .line-marker {
            position: absolute;
            top: 0;
            left: 0;
            transform: translateX(calc(-100% - 10px));
            width: 48px;
            height: 67px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .station-number-container {
            position: absolute;
            top: 23px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            border-radius: 5px;
            padding: 3.7px;
        }

        .station-number-inner {
            background: white;
            border-radius: 2px;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .markerLineCode {
            color: #000;
            font-weight: bold;
            font-size: 13px;
            line-height: 1;
            margin-bottom: 2px;
        }

        .markerStationCode {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }

        .line-number {
            color: #000;
            font-weight: bold;
            font-size: 18px;
            line-height: 0.8;
        }

        .station-info {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: auto;
            min-width: 200px;
            margin: 0 auto;
        }

        .station-name-ja {
            position: relative;
            display: inline-block;
            font-size: 45px;
            font-weight: bold;
            line-height: 1.2;
            font-family: 'MS Gothic', 'Yu Gothic', sans-serif;
            text-align: center;
            white-space: nowrap;
        }

        .station-name-hiragana {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            text-align: center;
            width: 100%;
        }

        .station-name-ko {
            font-size: 14px;
            color: #666;
            margin-bottom: 6px;
            text-align: center;
            width: 100%;
        }

        .ward-label {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 1px;
        }

        .ward-box {
            background: white;
            color: black;
            width: 16px;
            height: 16px;
            border: 1px solid black;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .ward-text {
            background: black;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .direction-bar {
            margin: 0 -15px;
            height: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: relative;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 50%, calc(100% - 15px) 100%, 0 100%);
            overflow: visible;
        }

        .station-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
        }

        .direction-left {
            padding-left: 15px;
            width: 33%;
            text-align: left;
        }

        .direction-right {
            padding-right: 20px;
            width: 33%;
            text-align: right;
        }

        .direction-station {
            font-size: 16px;
            font-weight: bold;
        }

        .station-names-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        .station-name-en {
            font-size: 16px;
            color: #333;
        }

        .station-name-en.current {
            font-weight: bold;
        }

        .station-name-en-left {
            width: 33%;
            text-align: left;
        }

        .station-name-en-center {
            width: 33%;
            text-align: center;
        }

        .station-name-en-right {
            width: 33%;
            text-align: right;
        }

        /* Media queries - consolidated */
        @media (max-width: 1200px) {
            .line-config .color-input {
                min-width: 90px;
            }
            
            .line-config input[type="text"] {
                width: 60px;
            }
        }

        @media (max-width: 992px) {
            .bottom-panels {
                flex-direction: column;
            }
            
            .bottom-panels > div {
                width: 100%;
            }

            .config-file-buttons {
                gap: 6px;
            }
            
            .config-file-buttons .btn {
                min-width: 70px;
            }

            .line-config .color-input {
                flex-grow: 1;
                max-width: none;
                min-width: 10px;
            }
        }

        @media (max-width: 768px) {
            .bottom-panels {
                flex-direction: column;
                gap: 10px;
            }

            .bottom-panels .editor-panel {
                flex-wrap: wrap;
            }

            .config-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            /* Optimize Line Config for mobile */
            .color-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .color-input label {
                font-size: 0.7rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .color-input input[type="text"] {
                max-width: 100px;
                min-width: 0;
                font-size: 0.8rem;
                padding: 2px 4px;
            }
            
            .color-input input[type="color"] {
                width: 28px;
                height: 26px;
            }

            .name-edit-group {
                flex-direction: column;
                width: 100%;
            }

            .name-edit-field {
                width: 100%;
                min-width: 0;
            }

            .name-edit-field select,
            .name-edit-field input {
                width: 100%;
            }

            .form-group.config-full {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group.config-full .btn {
                margin-top: 8px;
                height: 32px;
                width: 100%;
            }

            .selector-with-nav {
                width: 100%;
            }
            
            .selector-with-nav select {
                flex: 1;
            }

            .line-config .config-grid {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .config-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .config-file-buttons {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Preview panel stays at top -->
        <div class="top-panel">
            <div class="preview-panel">
                <h3>Station Sign Preview</h3>
                <div id="stationSignPreview"></div>
            </div>
        </div>

        <!-- Configuration and Line Configuration panels side by side -->
        <div class="bottom-panels">
            <!-- Configuration File panel -->
            <div class="editor-panel">
                <h3>Station Config File Editor V1.2.2</h3>
                <div class="config-file-section">
                    <div class="config-file-input control-item">
                        <label for="configFilename">Config Filename</label>
                        <input type="text" id="configFilename" value="stations_config.json">
                    </div>
                <div class="config-file-buttons">
                    <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="importConfig(this)">
                    <button class="btn" onclick="document.getElementById('configFileInput').click()">Import</button>
                    <button class="btn" onclick="exportConfig()">Export</button>
                    <button class="btn" onclick="saveChanges()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Line Configuration panel -->
            <div class="editor-panel line-config">
                <h3>Line Configuration</h3>
                <div class="config-grid">
                <div class="form-group">
                        <label for="lineSelect">Line</label>
                        <select id="lineSelect" onchange="updateLineSelection()"></select>
                    </div>
                    <div class="color-group">
                        <div class="color-input">
                            <label for="lineMarkerBgColor">Background</label>
                            <div class="input-group">
                            <input type="color" id="lineMarkerBgColor">
                            <input type="text" id="lineMarkerBgColorHex">
                            </div>
                        </div>
                        <div class="color-input">
                            <label for="lineNumberBgColor">Line Color</label>
                            <div class="input-group">
                            <input type="color" id="lineNumberBgColor">
                            <input type="text" id="lineNumberBgColorHex">
                            </div>
                        </div>
                        <div class="color-input">
                            <label for="directionBarBgColor">DirectionBar</label>
                            <div class="input-group">
                            <input type="color" id="directionBarBgColor">
                            <input type="text" id="directionBarBgColorHex">
                            </div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="addNewLine()">Add</button>
                        <button class="btn btn-danger" onclick="deleteLine()">Del</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Station Configuration Section -->
        <div class="editor-panel">
            <h3>Station Configuration</h3>
            <div class="config-grid">
                <div class="form-group config-full" style="display: flex; gap: 8px; align-items: center;">
                    <div class="name-edit-group">
                        <div class="name-edit-field">
                            <label>Station Selection</label>
                            <div class="selector-with-nav">
                                <select id="stationSelect" onchange="updateStationSelection()"></select>
                                <div class="nav-buttons">
                                    <button class="btn btn-small" onclick="navigateStation('prev')">&lt;</button>
                                    <button class="btn btn-small" onclick="navigateStation('next')">&gt;</button>
                                </div>
                            </div>
                        </div>
                        <div class="name-edit-field">
                            <label>Station Name(English)</label>
                            <input type="text" id="stationNameEdit" placeholder="Station name(EN)" onchange="updateStationName()">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewStation()">Add</button>
                    <button class="btn btn-danger" onclick="deleteStation()">Delete</button>
                </div>
                <div class="form-group">
                    <label>Station Code</label>
                    <input type="text" id="stationCode" placeholder="e.g., AKB">
                </div>
                <div class="form-group">
                    <label>Japanese</label>
                    <input type="text" id="stationNameJa">
                </div>
                <div class="form-group">
                    <label>Hiragana</label>
                    <input type="text" id="stationNameHiragana">
                </div>
                <div class="form-group">
                    <label>Korean</label>
                    <input type="text" id="stationNameKo">
                </div>
                <div class="form-group">
                    <label>Ward Box</label>
                    <input type="text" id="wardBox">
                </div>
            </div>
        </div>

        <!-- Track Configuration Section -->
        <div class="editor-panel">
            <h3>Track Configuration</h3>
            <div class="config-grid">
                <div class="form-group config-full" style="display: flex; gap: 8px; align-items: center;">
                    <div class="name-edit-group">
                        <div class="name-edit-field">
                            <label>Track Selection</label>
                            <select id="trackSelect" onchange="updateTrackSelection()"></select>
                        </div>
                        <div class="name-edit-field">
                            <label>Track Name</label>
                            <input type="text" id="trackNameEdit" placeholder="Track name" onchange="updateTrackName()">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewTrack()">Add</button>
                    <button class="btn btn-danger" onclick="deleteTrack()">Delete</button>
                    <button class="btn" onclick="saveChanges()">Save Changes</button>
                </div>
                <div class="form-group">
                    <label>Line Code</label>
                    <input type="text" id="trackLineCode">
                </div>
                <div class="form-group">
                    <label>Station Number</label>
                    <input type="text" id="trackStationNumber">
                </div>
                <div class="form-group">
                    <label>Melody</label>
                    <input type="number" id="melodyTrack" min="1" max="99">
                    </div>
                <div class="form-group">
                    <label>ATOS</label>
                    <input type="number" id="atosTrack" min="1" max="99">
                </div>
                <div class="form-group">
                    <label>Door Chime</label>
                    <input type="number" id="doorChimeTrack" min="1" max="99">
                </div>
                <div class="form-group">
                    <label>Platform VA</label>
                    <input type="number" id="vaTrack" min="1" max="99">
                </div>
                <!-- Direction information -->
                <div class="form-group">
                    <label>Previous Station (JP)</label>
                    <input type="text" id="prevStationJa">
                </div>
                <div class="form-group">
                    <label>Previous Station (EN)</label>
                    <input type="text" id="prevStationEn">
                </div>
                <div class="form-group">
                    <label>Next Station (JP)</label>
                    <input type="text" id="nextStationJa">
                </div>
                <div class="form-group">
                    <label>Next Station (EN)</label>
                    <input type="text" id="nextStationEn">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Main configuration data structure
        let configData = { lines: {} };

        // Event handlers and initialization
        document.addEventListener('DOMContentLoaded', () => {
            initializeEditor();

            // Set up color input event listeners
            document.querySelectorAll('input[type="color"]').forEach(input => {
                input.addEventListener('input', () => {
                    const hexInput = input.nextElementSibling;
                    if (hexInput) {
                        hexInput.value = input.value.toUpperCase();
                        saveChanges();
                    }
                });
            });

            document.querySelectorAll('.color-input input[type="text"]').forEach(input => {
                input.addEventListener('input', () => {
                    const colorInput = input.previousElementSibling;
                    if (colorInput && /^#[0-9A-F]{6}$/i.test(input.value)) {
                        colorInput.value = input.value.toUpperCase();
                        saveChanges();
                    }
                });
            });
        });

        // Core functions
        const initializeEditor = () => {
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '';
            
            if (configData?.lines) {
                Object.keys(configData.lines).forEach(lineCode => {
                    const option = document.createElement('option');
                    option.value = lineCode;
                    option.textContent = lineCode;
                    lineSelect.appendChild(option);
                });
                
                if (lineSelect.options.length > 0) {
                    lineSelect.selectedIndex = 0;
                    updateLineSelection();
                }
            }
            
            updatePreview();
        };

        const disableInputs = (disabled) => {
            document.querySelectorAll('input:not(#configFileInput), select').forEach(input => {
                input.disabled = disabled;
            });
            document.querySelectorAll('.btn:not([onclick*="configFileInput"])').forEach(btn => {
                btn.disabled = disabled;
            });
        };

        const updateLineSelection = () => {
            const lineCode = document.getElementById('lineSelect')?.value;
            if (!lineCode || !configData.lines[lineCode]) {
                disableInputs(true);
                return;
            }

            disableInputs(false);
            const line = configData.lines[lineCode];
            
            // Update color values
            if (line.style) {
                const colors = {
                    'lineMarkerBgColor': '#000000',
                    'lineNumberBgColor': '#80C241',
                    'directionBarBgColor': '#006400'
                };

                Object.keys(colors).forEach(colorKey => {
                    const value = line.style[colorKey] || colors[colorKey];
                    document.getElementById(colorKey).value = value;
                    document.getElementById(`${colorKey}Hex`).value = value;
                });
            }
            
            updateStationSelect(lineCode);
        };

        const updateStationSelect = (lineCode) => {
            const stationSelect = document.getElementById('stationSelect');
            stationSelect.innerHTML = '';
            
            Object.keys(configData.lines[lineCode].stations).forEach(stationName => {
                const option = document.createElement('option');
                option.value = stationName;
                option.textContent = stationName;
                stationSelect.appendChild(option);
            });

            updateStationSelection();
        };

        const updateStationSelection = () => {
            const lineCode = document.getElementById('lineSelect')?.value;
            const stationName = document.getElementById('stationSelect')?.value;
            
            if (!lineCode || !stationName) {
                console.log('Missing required values:', { lineCode, stationName });
                return;
            }
            
            const station = configData.lines[lineCode]?.stations[stationName];
            if (!station) {
                console.log('Station not found:', { lineCode, stationName });
                return;
            }

            try {
                // Update station name edit field
                document.getElementById('stationNameEdit').value = stationName;

                // Update station fields
                const stationInfo = station.sInfo;
                const fields = ['sC', 'Ja', 'Hi', 'Ko', 'wB'];
                const ids = ['stationCode', 'stationNameJa', 'stationNameHiragana', 'stationNameKo', 'wardBox'];
                
                fields.forEach((field, index) => {
                    document.getElementById(ids[index]).value = stationInfo[field] || '';
                });
                
                updateTrackSelect();
                updatePreview();
            } catch (error) {
                console.error('Error updating station selection:', error);
            }
        };

        const updatePreview = () => {
            const lineCode = document.getElementById('lineSelect')?.value;
            const stationName = document.getElementById('stationSelect')?.value;
            const trackNumber = document.getElementById('trackSelect')?.value;
            
            if (!lineCode || !stationName || !trackNumber) {
                document.getElementById('stationSignPreview').innerHTML = 
                    '<p>Import the Station Config Json file to preview or add a new line to create from scratch</p>';
                return;
            }

            const line = configData.lines[lineCode];
            const station = line?.stations[stationName];
            const tracks = station?.Trk;
            const track = tracks?.[trackNumber];
            
            if (!line || !station || !track) return;

            try {
                const preview = document.getElementById('stationSignPreview');
                const stationInfo = station.sInfo;
                const hasStationCode = Boolean(stationInfo.sC);
                const lineMarker = track.Marker;
                const direction = track.Dir;
                const prev = direction.p;
                const next = direction.n;
                
                preview.innerHTML = `
                    <div class="station-sign">
                        <div class="station-content">
                            <div class="line-marker" style="${hasStationCode ? 
                                `background: ${line.style?.lineMarkerBgColor || '#000000'}` : 
                                'background: transparent; box-shadow: none; transform: translate(-55px, -16px)'}">
                                <div class="markerStationCode">${stationInfo.sC || ''}</div>
                                <div class="station-number-container" style="background: ${line.style?.lineNumberBgColor || '#80C241'}">
                                    <div class="station-number-inner">
                                        <div class="markerLineCode">${lineMarker.LC || ''}</div>
                                        <div class="line-number">${lineMarker.sNum || ''}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="station-info">
                                <div class="station-name-ja">${stationInfo.Ja || ''}</div>
                                <div class="station-name-hiragana">${stationInfo.Hi || ''}</div>
                                <div class="station-name-ko">${stationInfo.Ko || ''}</div>
                            </div>
                        </div>
                        <div class="ward-label">
                            <div class="ward-box">${stationInfo.wB || ''}</div>
                            <div class="ward-text">区</div>
                        </div>
                        <div class="direction-bar" style="background: ${line.style?.directionBarBgColor || '#006400'}">
                            <div class="station-indicator" style="background: ${line.style?.lineNumberBgColor || '#80C241'}"></div>
                            <div class="direction-left">
                                <span class="direction-station">${prev.Ja || ''}</span>
                            </div>
                            <div class="direction-right">
                                <span class="direction-station">${next.Ja || ''}</span>
                            </div>
                        </div>
                        <div class="station-names-container">
                            <span class="station-name-en station-name-en-left">${prev.En || ''}</span>
                            <span class="station-name-en station-name-en-center current">${stationName}</span>
                            <span class="station-name-en station-name-en-right">${next.En || ''}</span>
                        </div>
                    </div>`;
                
                // Position update for line marker
                setTimeout(() => {
                    const stationNameJa = preview.querySelector('.station-name-ja');
                    const lineMarker = preview.querySelector('.line-marker');
                    const stationContent = preview.querySelector('.station-content');
                
                    if (stationNameJa && lineMarker && stationContent) {
                        const offset = stationNameJa.getBoundingClientRect().left - 
                                     stationContent.getBoundingClientRect().left;
                        lineMarker.style.left = offset + 'px';
                    }
                }, 50);
            } catch (error) {
                console.error('Error generating preview:', error);
            }
        };

        const createDefaultTrack = (lineCode) => ({
            Marker: {
                LC: lineCode,
                sNum: "01"
            },
            audio: {
                melody: 1,
                atos: 1,
                dC: 1,
                va: 1
            },
            Dir: {
                p: {
                    Ja: "前の駅",
                    En: "Previous Station"
                },
                n: {
                    Ja: "次の駅",
                    En: "Next Station"
                }
            }
        });

        // Line management functions
        const addNewLine = () => {
            const lineCode = prompt('Enter new line code:');
            if (!lineCode) return;
            
            // Delete the line if it already exists
            if (configData.lines[lineCode]) {
                delete configData.lines[lineCode];
            }
            
            configData.lines = {
                ...configData.lines,
                [lineCode]: {
                    style: {
                        lineMarkerBgColor: "#000000",
                        lineNumberBgColor: "#80C241",
                        directionBarBgColor: "#006400"
                    },
                    stations: {
                        "Sample Station": {
                            sInfo: {
                                sC: "SMP",
                                Ja: "サンプル駅",
                                Hi: "さんぷるえき",
                                Ko: "샘로운역",
                                wB: "山"
                            },
                            Trk: {
                                "track1": createDefaultTrack(lineCode)
                            }
                        }
                    }
                }
            };
            
            initializeEditor();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.value = lineCode;
            updateLineSelection();
        };

        // Station management functions
        const addNewStation = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationSelect = document.getElementById('stationSelect');
            const trackSelect = document.getElementById('trackSelect');
            const currentStation = stationSelect.value;
            
            // Check if next station fields are filled
            const nextStationEn = document.getElementById('nextStationEn').value.trim();
            const nextStationJa = document.getElementById('nextStationJa').value.trim();
            
            // Determine station name
            let stationName = (nextStationEn && nextStationEn !== "Next Station") 
                ? nextStationEn 
                : prompt('Enter new station name (English):');
                
            if (!stationName || !lineCode) return;
            
            // Get previous station info
            let prevStationJa = "前の駅";
            let prevStationEn = "Previous Station";
            
            if (currentStation && configData.lines[lineCode].stations[currentStation]) {
                const currentStationInfo = configData.lines[lineCode].stations[currentStation].sInfo;
                prevStationJa = currentStationInfo.Ja || "前の駅";
                prevStationEn = currentStation;
            } else {
                const existingStations = Object.keys(configData.lines[lineCode].stations);
                if (existingStations.length > 0) {
                    const lastStation = existingStations[existingStations.length - 1];
                    const lastStationInfo = configData.lines[lineCode].stations[lastStation].sInfo;
                    
                    if (lastStationInfo) {
                        prevStationJa = lastStationInfo.Ja || "前の駅";
                        prevStationEn = lastStation;
                    }
                }
            }
            
            // Create new station
            configData.lines[lineCode].stations[stationName] = {
                sInfo: {
                    Ja: nextStationJa && nextStationJa !== "次の駅" ? nextStationJa : "新しい駅",
                    sC: "",
                    Hi: "あたらしいえき",
                    Ko: "새로운역",
                    wB: "山"
                },
                Trk: {
                    "track1": {
                        Marker: {
                            LC: lineCode,
                            sNum: "01"
                        },
                        audio: {
                            melody: 1,
                            atos: 1,
                            dC: 1,
                            va: 1
                        },
                        Dir: {
                            p: {
                                Ja: prevStationJa,
                                En: prevStationEn
                            },
                            n: {
                                Ja: "次の駅",
                                En: "Next Station"
                            }
                        }
                    }
                }
            };
            
            // Update UI
            initializeEditor();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.value = lineCode;
            updateLineSelection();
            
            const newStationSelect = document.getElementById('stationSelect');
            newStationSelect.value = stationName;
            updateStationSelection();
            
            // Set track to track1
            const newTrackSelect = document.getElementById('trackSelect');
            if (newTrackSelect.options.length > 0) {
                newTrackSelect.value = "track1";
                updateTrackSelection();
            }
        };

        // Save changes to configuration
        const saveChanges = () => {
            const lineCode = document.getElementById('lineSelect')?.value;
            if (!lineCode) return;

            try {
                // Save line style
                configData.lines[lineCode].style = {
                    lineMarkerBgColor: document.getElementById('lineMarkerBgColor').value,
                    lineNumberBgColor: document.getElementById('lineNumberBgColor').value,
                    directionBarBgColor: document.getElementById('directionBarBgColor').value
                };

                const stationName = document.getElementById('stationSelect')?.value;
                const trackNumber = document.getElementById('trackSelect')?.value;
                
                if (!stationName || !trackNumber) return;

                const track = configData.lines[lineCode].stations[stationName].Trk[trackNumber];
                
                // Update track information
                track.Marker = {
                    LC: document.getElementById('trackLineCode').value,
                    sNum: document.getElementById('trackStationNumber').value
                };

                // Update audio tracks
                track.audio = {
                    melody: parseInt(document.getElementById('melodyTrack').value) || 1,
                    atos: parseInt(document.getElementById('atosTrack').value) || 1,
                    dC: parseInt(document.getElementById('doorChimeTrack').value) || 1,
                    va: parseInt(document.getElementById('vaTrack').value) || 1
                };

                track.Dir = {
                    p: {
                        Ja: document.getElementById('prevStationJa').value,
                        En: document.getElementById('prevStationEn').value
                    },
                    n: {
                        Ja: document.getElementById('nextStationJa').value,
                        En: document.getElementById('nextStationEn').value
                    }
                };

                // Update station info
                const station = configData.lines[lineCode].stations[stationName];
                station.sInfo = {
                    sC: document.getElementById('stationCode').value,
                    Ja: document.getElementById('stationNameJa').value,
                    Hi: document.getElementById('stationNameHiragana').value,
                    Ko: document.getElementById('stationNameKo').value,
                    wB: document.getElementById('wardBox').value
                };

                updatePreview();
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes. Check console for details.');
            }
        };

        // Data format conversion functions
        const prepareForExport = (data) => {
            const exportData = JSON.parse(JSON.stringify(data));
            
            Object.entries(exportData.lines).forEach(([_, line]) => {
                Object.entries(line.stations).forEach(([_, station]) => {
                    // Convert from internal format to export format
                    if (station.sInfo) {
                        station.i = [
                            station.sInfo.sC || "",
                            station.sInfo.Ja || "",
                            station.sInfo.Hi || "",
                            station.sInfo.Ko || "",
                            station.sInfo.wB || ""
                        ];
                        delete station.sInfo;
                    }
                    
                    if (station.Trk) {
                        station.t = [];
                        
                        // Convert each track from object to array
                        Object.entries(station.Trk).forEach(([trackName, track]) => {
                            station.t.push([
                                trackName,
                                track.Marker?.LC || "",
                                track.Marker?.sNum || "",
                                [
                                    track.audio?.melody || 1,
                                    track.audio?.atos || 1,
                                    track.audio?.dC || 1,
                                    track.audio?.va || 1
                                ],
                                [
                                    track.Dir?.p?.Ja || "",
                                    track.Dir?.p?.En || ""
                                ],
                                [
                                    track.Dir?.n?.Ja || "",
                                    track.Dir?.n?.En || ""
                                ]
                            ]);
                        });
                        
                        delete station.Trk;
                    }
                });
            });
            
            return exportData;
        };

        const prepareForImport = (data) => {
            const importData = JSON.parse(JSON.stringify(data));
            
            Object.entries(importData.lines).forEach(([_, line]) => {
                Object.entries(line.stations).forEach(([_, station]) => {
                    // Convert from import format to internal format
                    if (station.i && Array.isArray(station.i)) {
                        station.sInfo = {
                            sC: station.i[0] || "",
                            Ja: station.i[1] || "",
                            Hi: station.i[2] || "",
                            Ko: station.i[3] || "",
                            wB: station.i[4] || ""
                        };
                        delete station.i;
                    }
                    
                    if (station.t && Array.isArray(station.t)) {
                        station.Trk = {};
                        
                        // Convert each track from array to object
                        station.t.forEach(track => {
                            const trackName = track[0];
                            
                            station.Trk[trackName] = {
                                Marker: {
                                    LC: track[1] || "",
                                    sNum: track[2] || ""
                                },
                                audio: {
                                    melody: track[3][0] || 1,
                                    atos: track[3][1] || 1,
                                    dC: track[3][2] || 1,
                                    va: track[3][3] || 1
                                },
                                Dir: {
                                    p: {
                                        Ja: track[4][0] || "",
                                        En: track[4][1] || ""
                                    },
                                    n: {
                                        Ja: track[5][0] || "",
                                        En: track[5][1] || ""
                                    }
                                }
                            };
                        });
                        
                        delete station.t;
                    }
                });
            });
            
            return importData;
        };

        // File operations
        const importConfig = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    configData = prepareForImport(importedData);
                    
                    document.getElementById('configFilename').value = file.name;
                    initializeEditor();
                    
                    // Select first line
                    const lineSelect = document.getElementById('lineSelect');
                    const firstLine = Object.keys(configData.lines)[0];
                    if (firstLine) {
                        lineSelect.value = firstLine;
                        updateLineSelection();
                        
                        // Select first station
                        const stationSelect = document.getElementById('stationSelect');
                        if (stationSelect.options.length > 0) {
                            stationSelect.selectedIndex = 0;
                            updateStationSelection();
                        }
                    }
                    
                    disableInputs(false);
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                    console.error('Full error:', error);
                    console.log('Attempted to parse:', e.target.result);
                }
            };
            reader.readAsText(file, 'UTF-8');
        };

        const exportConfig = () => {
            // Convert to the export format
            const exportData = prepareForExport(configData);
            
            // JSON minification
            const jsonStr = JSON.stringify(exportData, null, 1);
            const fixedStr = jsonStr.replace(/\\\\/g, '\\')
                           .replace(/\n\s+/g, '\n')
                           .replace(/{\n/g, '{')
                           .replace(/\n}/g, '}')
                           .replace(/,\n/g, ',')
                           .replace(/\[\n/g, '[')
                           .replace(/\n\]/g, ']')
                           .replace(/": /g, '":');
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(fixedStr);
            const filename = document.getElementById('configFilename').value || 'stations_config.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
        };

        // Track management functions
        const updateTrackSelection = () => {
            const lineCode = document.getElementById('lineSelect')?.value;
            const stationName = document.getElementById('stationSelect')?.value;
            const trackNumber = document.getElementById('trackSelect')?.value;
            
            if (!lineCode || !stationName || !trackNumber) {
                console.log('Missing required values:', { lineCode, stationName, trackNumber });
                return;
            }
            
            const track = configData.lines[lineCode]?.stations[stationName]?.Trk[trackNumber];
            if (!track) {
                console.log('Track not found:', { lineCode, stationName, trackNumber });
                return;
            }

            try {
                // Update track name edit field
                document.getElementById('trackNameEdit').value = trackNumber;

                // Update marker fields
                const lineMarker = track.Marker;
                document.getElementById('trackLineCode').value = lineMarker.LC || '';
                document.getElementById('trackStationNumber').value = lineMarker.sNum || '';

                // Update audio tracks
                if (track.audio) {
                    const audioFields = ['melody', 'atos', 'dC', 'va'];
                    const audioIds = ['melodyTrack', 'atosTrack', 'doorChimeTrack', 'vaTrack'];
                    
                    audioFields.forEach((field, index) => {
                        document.getElementById(audioIds[index]).value = track.audio[field] || 1;
                    });
                }

                // Update direction information
                const direction = track.Dir;
                document.getElementById('prevStationJa').value = direction.p.Ja || '';
                document.getElementById('prevStationEn').value = direction.p.En || '';
                document.getElementById('nextStationJa').value = direction.n.Ja || '';
                document.getElementById('nextStationEn').value = direction.n.En || '';

                updatePreview();
            } catch (error) {
                console.error('Error updating track selection:', error);
            }
        };

        const addNewTrack = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            if (!lineCode || !stationName) return;

            const station = configData.lines[lineCode].stations[stationName];
            if (!station.Trk) {
                station.Trk = {};
            }

            // Get existing tracks info
            const trackKeys = Object.keys(station.Trk);
            const trackCount = trackKeys.length;
            const lastTrack = trackCount > 0 ? station.Trk[trackKeys[trackCount - 1]] : null;
            
            // Generate new track name
            let newTrackName;
            if (trackCount === 0) {
                newTrackName = 'track1';
            } else {
                const match = trackKeys[trackCount - 1].match(/(\D*)(\d+)$/);
                if (match) {
                    // Increment number in track name
                    const prefix = match[1];
                    const number = parseInt(match[2]) + 1;
                    newTrackName = `${prefix}${number}`;
                } else {
                    // Add number suffix
                    newTrackName = `${trackKeys[trackCount - 1]}2`;
                }
            }
            
            // Create new track with data from previous track
            station.Trk[newTrackName] = {
                Marker: {
                    LC: lastTrack?.Marker?.LC || lineCode,
                    sNum: lastTrack?.Marker?.sNum || "01"
                },
                audio: {
                    melody: lastTrack?.audio?.melody || 1,
                    atos: lastTrack?.audio?.atos || 1,
                    dC: lastTrack?.audio?.dC || 1,
                    va: lastTrack?.audio?.va || 1
                },
                Dir: {
                    // Swap previous and next station
                    p: {
                        Ja: lastTrack?.Dir?.n?.Ja || "",
                        En: lastTrack?.Dir?.n?.En || ""
                    },
                    n: {
                        Ja: lastTrack?.Dir?.p?.Ja || "",
                        En: lastTrack?.Dir?.p?.En || ""
                    }
                }
            };
            
            updateTrackSelect();
            const trackSelect = document.getElementById('trackSelect');
            trackSelect.value = newTrackName;
            updateTrackSelection();
        };

        const updateTrackSelect = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackSelect = document.getElementById('trackSelect');
            
            trackSelect.innerHTML = '';
            
            const tracks = configData.lines[lineCode]?.stations[stationName]?.Trk;
            if (!tracks) {
                trackSelect.innerHTML = '<option value="">No tracks available</option>';
                return;
            }
            
            Object.keys(tracks).forEach(trackNumber => {
                const option = document.createElement('option');
                option.value = trackNumber;
                option.textContent = trackNumber;
                trackSelect.appendChild(option);
            });

            if (trackSelect.options.length > 0) {
                trackSelect.selectedIndex = 0;
                updateTrackSelection();
            }
        };

        // Delete functions
        const deleteLine = () => {
            const lineCode = document.getElementById('lineSelect').value;
            if (!lineCode) return;
            
            if (confirm(`Are you sure you want to delete line ${lineCode}?`)) {
                delete configData.lines[lineCode];
                initializeEditor();
            }
        };

        const deleteStation = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            if (!lineCode || !stationName) return;
            
            if (confirm(`Are you sure you want to delete station ${stationName}?`)) {
                delete configData.lines[lineCode].stations[stationName];
                updateStationSelect(lineCode);
            }
        };

        const deleteTrack = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackNumber = document.getElementById('trackSelect').value;
            if (!lineCode || !stationName || !trackNumber) return;
            
            if (confirm(`Are you sure you want to delete track ${trackNumber}?`)) {
                delete configData.lines[lineCode].stations[stationName].Trk[trackNumber];
                updateTrackSelect();
            }
        };

        // Update name functions
        const updateStationName = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationSelect = document.getElementById('stationSelect');
            const oldName = stationSelect.value;
            const newName = document.getElementById('stationNameEdit').value.trim();
            
            if (!newName || !lineCode || !oldName || newName === oldName) return;
            
            try {
                // Clone station data and create with new name
                const stationData = JSON.parse(JSON.stringify(configData.lines[lineCode].stations[oldName]));
                delete configData.lines[lineCode].stations[oldName];
                configData.lines[lineCode].stations[newName] = stationData;
                
                // Update UI
                updateStationSelect(lineCode);
                stationSelect.value = newName;
                document.getElementById('stationNameEdit').value = newName;
                updateStationSelection();
            } catch (error) {
                console.error('Error updating station name:', error);
                alert('Error updating station name');
            }
        };

        const updateTrackName = () => {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackSelect = document.getElementById('trackSelect');
            const oldName = trackSelect.value;
            const newName = document.getElementById('trackNameEdit').value.trim();
            
            if (!newName || !lineCode || !stationName || !oldName || newName === oldName) return;
            
            try {
                // Clone track data and create with new name
                const trackData = JSON.parse(JSON.stringify(
                    configData.lines[lineCode].stations[stationName].Trk[oldName]
                ));
                delete configData.lines[lineCode].stations[stationName].Trk[oldName];
                configData.lines[lineCode].stations[stationName].Trk[newName] = trackData;
                
                // Update UI
                updateTrackSelect();
                trackSelect.value = newName;
                document.getElementById('trackNameEdit').value = newName;
                updateTrackSelection();
            } catch (error) {
                console.error('Error updating track name:', error);
                alert('Error updating track name');
            }
        };

        // Navigation function
        const navigateStation = (direction) => {
            const stationSelect = document.getElementById('stationSelect');
            const currentIndex = stationSelect.selectedIndex;
            
            if (direction === 'prev' && currentIndex > 0) {
                stationSelect.selectedIndex = currentIndex - 1;
            } else if (direction === 'next' && currentIndex < stationSelect.options.length - 1) {
                stationSelect.selectedIndex = currentIndex + 1;
            }
            
            updateStationSelection();
        };
    </script>
</body>
</html> 
