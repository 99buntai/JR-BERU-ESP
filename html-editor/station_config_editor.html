<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JR Station Configuration Editor</title>
    <style>
        /* Base styles */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            line-height: 1.6;
            padding: 20px; 
        }

        /* Layout */
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Add new layout styles */
        .top-panel {
            width: 100%;
        }

        /* Make select inputs more responsive */
        .line-config select {
            min-width: 100px;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .line-config .color-input {
                min-width: 90px;
            }
            
            .line-config input[type="text"] {
                width: 55px;
            }
        }

        @media (max-width: 992px) {
            .bottom-panels {
                flex-direction: column;
            }
            
            .bottom-panels > div {
                width: 100%;
            }
        }

        /* Adjust panel widths */
        .bottom-panels > div:first-child {
            flex: 0 0 auto;  /* Don't grow, don't shrink, auto width */
            width: 300px;    /* Fixed width for Configuration File panel */
        }

        .bottom-panels > div:last-child {
            flex: 1;         /* Allow Line Configuration panel to grow */
            min-width: 0;    /* Allow panel to shrink if needed */
        }

        /* Make the panels more compact */
        .bottom-panels .editor-panel {
            padding: 12px 12px;
            height: auto;
            display: flex;
            align-items: center;
        }

        /* Adjust headings in bottom panels */
        .bottom-panels h3 {
            margin: 0;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Make buttons more compact and in single line */
        .bottom-panels .btn-group {
            display: flex;
            gap: 8px;
            margin: 0;
            flex-wrap: nowrap;
        }

        .bottom-panels .btn {
            flex: 1;
            min-width: 70px;
            padding: 4px 10px;
            white-space: nowrap;
        }

        /* Adjust select and button container */
        .bottom-panels .config-grid {
            display: flex;
            gap: 8px;
            margin: 0;
            flex: 1;
        }

        .bottom-panels .form-group.config-full {
            flex: 1;
            margin: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .bottom-panels {
                flex-direction: column;
                gap: 10px;
            }

            .bottom-panels .editor-panel {
                flex-wrap: wrap;
            }
        }

        /* Editor Panel */
        .editor-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-section {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 6px;
        }

        .editor-section h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            width: 100%;
        }

        /* Preview Panel */
        .preview-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }

        label {
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: #666;
        }

        input, select {
            padding: 4px 6px;
            font-size: 0.9rem;
            height: 28px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Color input groups */
        .color-input {
            display: flex;
            flex-direction: column;
        }

        .color-input .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .color-input input[type="color"] {
            width: 40px;
            height: 28px;
            padding: 0;
        }

        .color-input input[type="text"] {
            flex: 1;
        }

        /* Buttons */
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            flex: 0 1 auto;  /* Allow buttons to shrink but not grow */
            white-space: nowrap;
        }

        .btn:hover {
            background: #1976D2;
        }

        .btn-group {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: flex-start;
        }

        /* Stack filename input and buttons in a vertical layout */
        .config-file-section {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Adjust spacing between input and buttons */
            width: 100%;
        }

        /* Config filename input */
        .config-file-input {
            display: block;
        }
        
        #configFilename {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Station Sign Preview Styles */
        .station-sign {
            background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 100%);
            padding: 15px 15px 0; 
            position: relative; 
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            overflow: hidden;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .station-content { 
            position: relative; 
            width: 100%; 
            display: flex; 
            justify-content: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 60px; /* Add padding to prevent text from touching edges */
        }

        .line-marker {
            position: absolute;
            top: 0;
            left: 0;
            transform: translateX(calc(-100% - 10px)); /* Position 10px to the left of the container */
            width: 48px; 
            height: 67px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .station-number-container { 
            position: absolute; 
            top: 23px; 
            left: 3px; 
            right: 3px; 
            bottom: 3px;
            border-radius: 5px; 
            padding: 3.7px; 
        }

        .station-number-inner { 
            background: white; 
            border-radius: 2px; 
            height: 100%; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }

        .line-code-jy { 
            color: #000; 
            font-weight: bold; 
            font-size: 13px; 
            line-height: 1; 
            margin-bottom: 2px; 
        }

        .line-code-akb { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            color: white;
            font-weight: bold; 
            font-size: 16px; 
            text-align: center; 
        }

        .line-number { 
            color: #000; 
            font-weight: bold; 
            font-size: 18px; 
            line-height: 0.8; 
        }

        .station-info { 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            width: auto; /* Allow width to be dynamic */
            min-width: 200px; /* Minimum width for very short names */
            margin: 0 auto;
        }

        .station-name-ja {
            position: relative; 
            display: inline-block; 
            font-size: 45px; 
            font-weight: bold;
            line-height: 1.2; 
            font-family: 'MS Gothic', 'Yu Gothic', sans-serif; 
            text-align: center;
            white-space: nowrap; /* Prevent name from wrapping */
        }

        .station-name-hiragana { 
            font-size: 16px; 
            font-weight: bold;
            color: #333; 
            text-align: center;
            width: 100%;
        }

        .station-name-ko { 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 6px; 
            text-align: center;
            width: 100%;
        }

        .ward-label { 
            position: absolute; 
            top: 15px; 
            right: 50px; 
            display: flex; 
            gap: 1px; 
        }

        .ward-box { 
            background: white; 
            color: black; 
            width: 16px; 
            height: 16px;
            border: 1px solid black; 
            border-radius: 2px; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            font-size: 12px; 
        }

        .ward-text { 
            background: black; 
            color: white; 
            width: 16px; 
            height: 16px;
            border-radius: 2px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 12px; 
        }

        .direction-bar {
            margin: 0 -15px; 
            height: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center; 
            color: white;
            position: relative;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 50%, calc(100% - 15px) 100%, 0 100%);
            overflow: visible; 
        }

        .station-indicator { 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%);
            width: 32px; 
            height: 32px; 
        }

        .direction-left { 
            padding-left: 15px; 
            width: 33%; 
            text-align: left; 
        }

        .direction-right { 
            padding-right: 20px; 
            width: 33%; 
            text-align: right;
        }

        .direction-station { 
            font-size: 16px; 
            font-weight: bold; 
        }

        .station-names-container { 
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
            max-width: 700px; 
            margin: 0 auto; 
        }

        .station-name-en { 
            font-size: 16px; 
            color: #333; 
        }

        .station-name-en.current { 
            font-weight: bold; 
        }

        .station-name-en-left { 
            width: 33%; 
            text-align: left; 
        }

        .station-name-en-center { 
            width: 33%; 
            text-align: center; 
        }

        .station-name-en-right { 
            width: 33%; 
            text-align: right;
        }

        /* Add these styles */
        .editor-section + .editor-section {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        /* Line config grid */
        .line-config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .line-config-grid .form-group {
            margin-bottom: 0;
        }

        .line-config-full {
            grid-column: 1 / -1;
        }

        /* Make labels and inputs more compact */
        .line-config-grid label {
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .line-config-grid input, 
        .line-config-grid select {
            padding: 6px;
        }

        /* Station Configuration Grid */
        .station-config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .station-config-grid .form-group {
            margin-bottom: 0;
        }

        .station-config-full {
            grid-column: 1 / -1;
        }

        .preview-panel h3 {
            font-size: 1rem;
            margin-bottom: 12px;
        }

        /* Make configurations more compact with 3 columns */
        .config-grid {
            display: grid;
            /* Use auto-fit to dynamically adjust columns based on screen width */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            align-items: start;
        }

        /* Adjust minimum width for mobile */
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        /* Adjust for very small screens */
        @media (max-width: 480px) {
            .config-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

        /* Keep full-width items spanning all columns */
        .config-grid .form-group.config-full {
            grid-column: 1 / -1;
        }

        /* Make inputs and labels more compact */
        .config-grid label {
            font-size: 0.75rem;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .config-grid input,
        .config-grid select {
            padding: 4px;
            height: 26px;
            font-size: 0.85rem;
            width: 100%;
            min-width: 0; /* Allow inputs to shrink */
        }

        .config-grid .color-input {
            gap: 4px;
        }

        .config-grid .color-input input[type="color"] {
            width: 30px;
            height: 26px;
        }

        /* Add to existing styles */
        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Adjust select height */
        .bottom-panels select {
            height: 24px;
            padding: 2px 6px;
        }

        /* Line config specific styles */
        .line-config h3 {
            font-size: 0.85rem;
            margin: 0;
            white-space: nowrap;
        }

        .line-config label {
            font-size: 0.75rem;
            white-space: nowrap;
            margin: 0;
        }

        .line-config input[type="color"] {
            width: 24px;
            height: 24px;
            padding: 0;
            flex-shrink: 0;  /* Prevent color picker from shrinking */
        }

        .line-config input[type="text"] {
            width: 85px;  /* Final width for hex input */
            height: 24px;
            padding: 2px 4px;
            font-size: 0.8rem;
            flex-shrink: 0;  /* Prevent hex input from shrinking */
        }

        /* Update bottom panels layout */
        .bottom-panels {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .config-file-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            margin-left: auto;
            flex: 1;  /* Take remaining space */
        }

        .config-file-buttons .btn {
            flex: 1;  /* Make buttons equal width */
            min-width: 60px;  /* Slightly wider minimum */
            padding: 4px 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Responsive adjustments for Config File panel */
        @media (max-width: 992px) {
            .config-file-buttons {
                gap: 6px;
            }
            
            .config-file-buttons .btn {
                min-width: 70px;  /* Even wider on smaller screens */
            }

            .line-config .color-input {
                flex-grow: 1;
                max-width: none; /* Remove max-width restriction for better flexibility */
                min-width: 10px;
            }
        }

        @media (max-width: 480px) {
            .config-file-buttons {
                width: 100%;  /* Full width on very small screens */
            }
        }

        .line-config .color-input {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 100px;
            max-width: 180px;
        }

        .line-config .color-input label {
            width: 70px;  /* Fixed width for labels */
            white-space: nowrap;
        }

        /* Line Config panel adjustments */
        .line-config .form-group {
            flex: 0 1 auto;  /* Don't grow, allow shrink */
            width: 100px;    /* Reduce fixed width for line selector */
            min-width: 100px; /* Reduce minimum width */
        }

        /* Button group adjustments */
        .line-config .btn-group {
            display: flex;
            flex: 0 0 auto;  /* Don't grow or shrink */
        }

        /* Ensure container doesn't overflow */
        .line-config .config-grid {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: nowrap;
            min-width: 0;    /* Allow container to shrink */
            overflow: hidden; /* Prevent overflow */
        }

        /* Color group adjustments */
        .line-config .color-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;    /* Allow container to shrink */
            margin: 0 8px;   /* Add some spacing */
        }

        .name-edit-field select,
        .name-edit-field input {
            margin-top: 2px;
            width: 100%;
        }

        .name-edit-group {
            display: flex;
            gap: 4px;
            align-items: flex-start;
            flex: 1;
            flex-wrap: wrap;
        }

        .name-edit-field {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 120px;
        }

        /* Adjust button styles */
        .form-group.config-full .btn {
            height: 28px;  /* Match input height */
            padding: 0 16px;
            align-self: flex-end;  /* Align buttons to the bottom of the form group */
        }

        /* Navigation button styles */
        .selector-with-nav {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .nav-buttons {
            display: flex;
            gap: 2px;
        }

        .btn-small {
            padding: 0 8px;
            height: 28px;
            min-width: 28px;
            font-size: 14px;
        }

        /* Adjust select width when nav buttons are present */
        .selector-with-nav select {
            width: calc(100% - 64px);  /* Account for nav buttons */
        }

        /* Panel headers alignment */
        .editor-panel h3 {
            text-align: left;
        }

        /* Ensure config grid starts after the header */
        .config-grid, .config-file-section {
            width: 100%;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            /* Optimize Line Config for mobile */
            .color-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .color-input label {
                font-size: 0.7rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .color-input input[type="text"] {
                max-width: 100px;
                min-width: 0;
                font-size: 0.8rem;
                padding: 2px 4px;
            }
            
            .color-input input[type="color"] {
                width: 28px;
                height: 26px;
            }

            .name-edit-group {
                flex-direction: column;
                width: 100%;
            }

            .name-edit-field {
                width: 100%;
                min-width: 0;
            }

            .name-edit-field select,
            .name-edit-field input {
                width: 100%;
            }

            .form-group.config-full {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group.config-full .btn {
                margin-top: 8px;
                height: 32px;  /* Slightly taller on mobile */
                width: 100%;  /* Full width buttons on mobile */
            }

            .selector-with-nav {
                width: 100%;
            }
            
            .selector-with-nav select {
                flex: 1;
            }

            .line-config .config-grid {
                flex-direction: column; /* Stack elements vertically on smaller screens */
                align-items: stretch; /* Stretch elements to full width */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Preview panel stays at top -->
        <div class="top-panel">
            <div class="preview-panel">
                <h3>Station Sign Preview</h3>
                <div id="stationSignPreview"></div>
            </div>
        </div>

        <!-- Configuration and Line Configuration panels side by side -->
        <div class="bottom-panels">
            <!-- Configuration File panel -->
            <div class="editor-panel">
                <h3>Station Config File Editor V1.2.1</h3>
                <div class="config-file-section">
                    <div class="config-file-input control-item">
                        <label for="configFilename">Config Filename</label>
                        <input type="text" id="configFilename" value="stations_config.json">
                    </div>
                <div class="config-file-buttons">
                    <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="importConfig(this)">
                    <button class="btn" onclick="document.getElementById('configFileInput').click()">Import</button>
                    <button class="btn" onclick="exportConfig()">Export</button>
                    <button class="btn" onclick="saveChanges()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Line Configuration panel -->
            <div class="editor-panel line-config">
                <h3>Line Configuration</h3>
                <div class="config-grid">
                <div class="form-group">
                        <label for="lineSelect">Select Line</label>
                        <select id="lineSelect" onchange="updateLineSelection()"></select>
                    </div>
                    <div class="color-group">
                        <div class="color-input">
                            <label for="lineMarkerBgColor">Background</label>
                            <div class="input-group">
                            <input type="color" id="lineMarkerBgColor">
                            <input type="text" id="lineMarkerBgColorHex">
                            </div>
                        </div>
                        <div class="color-input">
                            <label for="lineNumberBgColor">Line Color</label>
                            <div class="input-group">
                            <input type="color" id="lineNumberBgColor">
                            <input type="text" id="lineNumberBgColorHex">
                            </div>
                        </div>
                        <div class="color-input">
                            <label for="directionBarBgColor">DirectionBar</label>
                            <div class="input-group">
                            <input type="color" id="directionBarBgColor">
                            <input type="text" id="directionBarBgColorHex">
                            </div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="addNewLine()">Add</button>
                        <button class="btn btn-danger" onclick="deleteLine()">Del</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Station Configuration Section -->
        <div class="editor-panel">
            <h3>Station Configuration</h3>
            <div class="config-grid">
                <div class="form-group config-full" style="display: flex; gap: 8px; align-items: center;">
                    <div class="name-edit-group">
                        <div class="name-edit-field">
                            <label>Station Selection</label>
                            <div class="selector-with-nav">
                                <select id="stationSelect" onchange="updateStationSelection()"></select>
                                <div class="nav-buttons">
                                    <button class="btn btn-small" onclick="navigateStation('prev')">&lt;</button>
                                    <button class="btn btn-small" onclick="navigateStation('next')">&gt;</button>
                                </div>
                            </div>
                        </div>
                        <div class="name-edit-field">
                            <label>Station Name(English)</label>
                            <input type="text" id="stationNameEdit" placeholder="Station name(EN)" onchange="updateStationName()">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewStation()">Add</button>
                    <button class="btn btn-danger" onclick="deleteStation()">Delete</button>
                </div>
                <div class="form-group">
                    <label>Station Code</label>
                    <input type="text" id="stationCode" placeholder="e.g., AKB">
                </div>
                <div class="form-group">
                    <label>Japanese</label>
                    <input type="text" id="stationNameJa">
                </div>
                <div class="form-group">
                    <label>Hiragana</label>
                    <input type="text" id="stationNameHiragana">
                </div>
                <div class="form-group">
                    <label>Korean</label>
                    <input type="text" id="stationNameKo">
                </div>
                <div class="form-group">
                    <label>Ward Box</label>
                    <input type="text" id="wardBox">
                </div>
            </div>
        </div>

        <!-- Track Configuration Section -->
        <div class="editor-panel">
            <h3>Track Configuration</h3>
            <div class="config-grid">
                <div class="form-group config-full" style="display: flex; gap: 8px; align-items: center;">
                    <div class="name-edit-group">
                        <div class="name-edit-field">
                            <label>Track Selection</label>
                            <select id="trackSelect" onchange="updateTrackSelection()"></select>
                        </div>
                        <div class="name-edit-field">
                            <label>Track Name</label>
                            <input type="text" id="trackNameEdit" placeholder="Track name" onchange="updateTrackName()">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewTrack()">Add</button>
                    <button class="btn btn-danger" onclick="deleteTrack()">Delete</button>
                    <button class="btn" onclick="saveChanges()">Save Changes</button>
                </div>
                <div class="form-group">
                    <label>Line Code</label>
                    <input type="text" id="trackLineCode">
                </div>
                <div class="form-group">
                    <label>Station Number</label>
                    <input type="text" id="trackStationNumber">
                </div>
                <div class="form-group">
                    <label>Melody</label>
                    <input type="number" id="melodyTrack" min="1" max="99">
                    </div>
                <div class="form-group">
                    <label>ATOS</label>
                    <input type="number" id="atosTrack" min="1" max="99">
                </div>
                <div class="form-group">
                    <label>Door Chime</label>
                    <input type="number" id="doorChimeTrack" min="1" max="99">
                </div>
                <div class="form-group">
                    <label>Platform VA</label>
                    <input type="number" id="vaTrack" min="1" max="99">
                </div>
                <!-- Direction information -->
                <div class="form-group">
                    <label>Previous Station (JP)</label>
                    <input type="text" id="prevStationJa">
                </div>
                <div class="form-group">
                    <label>Previous Station (EN)</label>
                    <input type="text" id="prevStationEn">
                </div>
                <div class="form-group">
                    <label>Next Station (JP)</label>
                    <input type="text" id="nextStationJa">
                </div>
                <div class="form-group">
                    <label>Next Station (EN)</label>
                    <input type="text" id="nextStationEn">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize configData at the top level
        let configData = {
            lines: {}
        };

        // Move initialization into DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();

            // Add event listeners for color inputs
            document.querySelectorAll('input[type="color"]').forEach(input => {
                input.addEventListener('input', function() {
                    const hexInput = this.nextElementSibling;
                    if (hexInput) {
                        hexInput.value = this.value.toUpperCase();
                        saveChanges();  // Auto-save when color changes
                    }
                });
            });

            document.querySelectorAll('.color-input input[type="text"]').forEach(input => {
                input.addEventListener('input', function() {
                    const colorInput = this.previousElementSibling;
                    if (colorInput && /^#[0-9A-F]{6}$/i.test(this.value)) {
                        colorInput.value = this.value.toUpperCase();
                        saveChanges();  // Auto-save when hex value changes
                    }
                });
            });
        });
        //initialize editor
        function initializeEditor() {
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '';
            
            if (configData && configData.lines) {
                Object.keys(configData.lines).forEach(lineCode => {
                    const option = document.createElement('option');
                    option.value = lineCode;
                    option.textContent = lineCode;
                    lineSelect.appendChild(option);
                });
                
                if (lineSelect.options.length > 0) {
                    lineSelect.selectedIndex = 0;  // This will now select the first actual line
                    updateLineSelection();
                }
            }
            
            updatePreview();
        }
        //disable inputs
        function disableInputs(disabled) {
            // Disable all inputs except import when no data
            document.querySelectorAll('input:not(#configFileInput), select').forEach(input => {
                input.disabled = disabled;
            });
            document.querySelectorAll('.btn:not([onclick*="configFileInput"])').forEach(btn => {
                btn.disabled = disabled;
            });
        }
        //update line selection
        function updateLineSelection() {
            const lineCode = document.getElementById('lineSelect')?.value;
            if (!lineCode || !configData.lines[lineCode]) {
                disableInputs(true);
                return;
            }

            disableInputs(false);
            const line = configData.lines[lineCode];
            
            // Update color values
            if (line.style) {
                document.getElementById('lineMarkerBgColor').value = line.style.lineMarkerBgColor || '#000000';
                document.getElementById('lineMarkerBgColorHex').value = line.style.lineMarkerBgColor || '#000000';
                document.getElementById('lineNumberBgColor').value = line.style.lineNumberBgColor || '#80C241';
                document.getElementById('lineNumberBgColorHex').value = line.style.lineNumberBgColor || '#80C241';
                document.getElementById('directionBarBgColor').value = line.style.directionBarBgColor || '#006400';
                document.getElementById('directionBarBgColorHex').value = line.style.directionBarBgColor || '#006400';
            }
            
            updateStationSelect(lineCode);
        }
        //update station select
        function updateStationSelect(lineCode) {
            const stationSelect = document.getElementById('stationSelect');
            stationSelect.innerHTML = '';
            
            Object.keys(configData.lines[lineCode].stations).forEach(stationName => {
                const option = document.createElement('option');
                option.value = stationName;
                option.textContent = stationName;
                stationSelect.appendChild(option);
            });

            updateStationSelection();
        }
        //update station selection
        function updateStationSelection() {
            const lineCode = document.getElementById('lineSelect')?.value;
            const stationName = document.getElementById('stationSelect')?.value;
            
            if (!lineCode || !stationName) {
                console.log('Missing required values:', { lineCode, stationName });
                return;
            }
            
            const station = configData.lines[lineCode]?.stations[stationName];
            if (!station) {
                console.log('Station not found:', { lineCode, stationName });
                return;
            }

            try {
                // Update station name edit field
                document.getElementById('stationNameEdit').value = stationName;

                // Use only new property names
                const stationInfo = station.sInfo;
                document.getElementById('stationCode').value = stationInfo.sC || '';
                document.getElementById('stationNameJa').value = stationInfo.Ja || '';
                document.getElementById('stationNameHiragana').value = stationInfo.Hi || '';
                document.getElementById('stationNameKo').value = stationInfo.Ko || '';
                document.getElementById('wardBox').value = stationInfo.wB || '';
                
                updateTrackSelect();
                updatePreview();
            } catch (error) {
                console.error('Error updating station selection:', error);
            }
        }
         //update preview
        function updatePreview() {
            const lineCode = document.getElementById('lineSelect')?.value;//get line code
            const stationName = document.getElementById('stationSelect')?.value;//get station name
            const trackNumber = document.getElementById('trackSelect')?.value;  // Get current track
            
            if (!lineCode || !stationName || !trackNumber) {
                document.getElementById('stationSignPreview').innerHTML = '<p>Import the Station Config Json file to preview or add a new line to create from scratch</p>';
                return;
            }

            const line = configData.lines[lineCode];//get line
            const station = line?.stations[stationName];//get station
            
            // Use only new property names
            const tracks = station?.Trk;
            const track = tracks?.[trackNumber];
            
            if (!line || !station || !track) return;//check if line, station, and track are empty

            try {
                const preview = document.getElementById('stationSignPreview');//get preview
                
                // Use only new property names
                const stationInfo = station.sInfo;
                const hasStationCode = !!stationInfo.sC;
                
                // Use only new property names
                const lineMarker = track.Marker;
                
                // Use only new property names
                const direction = track.Dir;
                const prev = direction.p;
                const next = direction.n;
                
                preview.innerHTML = `
                    <div class="station-sign">
                        <div class="station-content">
                            <div class="line-marker" style="${hasStationCode ? 
                                `background: ${line.style?.lineMarkerBgColor || '#000000'}` : 
                                'background: transparent; box-shadow: none; transform: translate(-55px, -16px)'}">
                                <div class="line-code-akb">${stationInfo.sC || ''}</div>
                                <div class="station-number-container" style="background: ${line.style?.lineNumberBgColor || '#80C241'}">
                                    <div class="station-number-inner">
                                        <div class="line-code-jy">${lineMarker.LC || ''}</div>
                                        <div class="line-number">${lineMarker.sNum || ''}</div>
                    </div>
                    </div>
                            </div>
                            <div class="station-info">
                                <div class="station-name-ja">${stationInfo.Ja || ''}</div>
                                <div class="station-name-hiragana">${stationInfo.Hi || ''}</div>
                                <div class="station-name-ko">${stationInfo.Ko || ''}</div>
                            </div>
                        </div>
                        <div class="ward-label">
                            <div class="ward-box">${stationInfo.wB || ''}</div>
                            <div class="ward-text">区</div>
                    </div>
                        <div class="direction-bar" style="background: ${line.style?.directionBarBgColor || '#006400'}">
                            <div class="station-indicator" style="background: ${line.style?.lineNumberBgColor || '#80C241'}"></div>
                            <div class="direction-left">
                                <span class="direction-station">${prev.Ja || ''}</span>
                </div>
                            <div class="direction-right">
                                <span class="direction-station">${next.Ja || ''}</span>
                            </div>
                        </div>
                        <div class="station-names-container">
                            <span class="station-name-en station-name-en-left">${prev.En || ''}</span>
                            <span class="station-name-en station-name-en-center current">${stationName}</span>
                            <span class="station-name-en station-name-en-right">${next.En || ''}</span>
                        </div>
                    </div>`;
                
                // Manually trigger positioning update after HTML is rendered
                setTimeout(() => {
                    const stationNameJa = preview.querySelector('.station-name-ja');
                    const lineMarker = preview.querySelector('.line-marker');
                    const stationContent = preview.querySelector('.station-content');
                
                if (stationNameJa && lineMarker && stationContent) {
                        const offset = stationNameJa.getBoundingClientRect().left - 
                                     stationContent.getBoundingClientRect().left;
                        lineMarker.style.left = offset + 'px';
                    }
                }, 50);

            } catch (error) {
                console.error('Error generating preview:', error);
            }
        }
        //create default track
        function createDefaultTrack(lineCode) {
            return {
                "Marker": {
                    "LC": lineCode,
                    "sNum": "01"
                },
                "audio": {
                    "melody": 1,
                    "atos": 1,
                    "dC": 1,
                    "va": 1
                },
                "Dir": {
                    "p": {
                        "Ja": "前の駅",
                        "En": "Previous Station"
                    },
                    "n": {
                        "Ja": "次の駅",
                        "En": "Next Station"
                    }
                }
            };
        }
        //add new line
        function addNewLine() {
            const lineCode = prompt('Enter new line code:');
            if (lineCode) {
                // Delete the line if it already exists
                if (configData.lines[lineCode]) {
                    delete configData.lines[lineCode];
                }
                
                // Use spread operator (more concise) to create new lines object 
                configData.lines = {
                    ...configData.lines,
                    [lineCode]: {
                style: {
                        lineMarkerBgColor: "#000000",
                        lineNumberBgColor: "#80C241",
                        directionBarBgColor: "#006400"
                    },
                    stations: {
                        "Sample Station": {
                                "sInfo": {
                                    "sC": "SMP",
                                    "Ja": "サンプル駅",
                                    "Hi": "さんぷるえき",
                                    "Ko": "샘로운역",
                                    "wB": "山"
                                },
                                "Trk": {
                                "track1": createDefaultTrack(lineCode)
                                }
                            }
                        }
                    }
                };
                
                initializeEditor();
                const lineSelect = document.getElementById('lineSelect');
                lineSelect.value = lineCode;
                updateLineSelection();
            }
        }

        function addNewStation() {
            const lineCode = document.getElementById('lineSelect').value;
            // Get current track information
            const stationSelect = document.getElementById('stationSelect');
            const trackSelect = document.getElementById('trackSelect');
            const currentStation = stationSelect.value;
            const currentTrack = trackSelect.value;
            
            // Check if next station fields are filled
            const nextStationEn = document.getElementById('nextStationEn').value.trim();
            const nextStationJa = document.getElementById('nextStationJa').value.trim();
            
            // Use the next station fields if filled, otherwise prompt for name
            let stationName = "";
            
            if (nextStationEn && nextStationEn !== "Next Station") {
                stationName = nextStationEn;
            } else {
                stationName = prompt('Enter new station name (English):');
                if (!stationName) return; // User canceled
            }
            
            if (lineCode && stationName) {
                // Get all existing stations for the current line
                const existingStations = Object.keys(configData.lines[lineCode].stations);
                
                // Find information for the previous station (if any)
                let prevStationJa = "前の駅";
                let prevStationEn = "Previous Station";
                
                // Use current station as the previous station for the new one
                if (currentStation && configData.lines[lineCode].stations[currentStation]) {
                    const currentStationInfo = configData.lines[lineCode].stations[currentStation].sInfo;
                    prevStationJa = currentStationInfo.Ja || "前の駅";
                    prevStationEn = currentStation;
                } else if (existingStations.length > 0) {
                    // Get the last station in the list to use as the previous station
                    const lastStation = existingStations[existingStations.length - 1];
                    const lastStationInfo = configData.lines[lineCode].stations[lastStation].sInfo;
                    
                    if (lastStationInfo) {
                        // Use the last station's Japanese and English names
                        prevStationJa = lastStationInfo.Ja || "前の駅";
                        prevStationEn = lastStation;
                    }
                }
                
                // Create new station with default values
            configData.lines[lineCode].stations[stationName] = {
                    "sInfo": {
                        "Ja": nextStationJa && nextStationJa !== "次の駅" ? nextStationJa : "新しい駅",
                        "sC": "",
                        "Hi": "あたらしいえき",
                        "Ko": "새로운역",
                        "wB": "山"
                    },
                    "Trk": {
                        "track1": {
                            "Marker": {
                                "LC": lineCode,
                                "sNum": "01"
                            },
                            "audio": {
                                "melody": 1,
                                "atos": 1,
                                "dC": 1,
                                "va": 1
                            },
                            "Dir": {
                                "p": {
                                    "Ja": prevStationJa,
                                    "En": prevStationEn
                                },
                                "n": {
                                    "Ja": "次の駅",
                                    "En": "Next Station"
                                }
                            }
                        }
                    }
                };
                
                // Refresh the UI
                initializeEditor();
                
                // Set selectors to show the newly added station
                const lineSelect = document.getElementById('lineSelect');
                lineSelect.value = lineCode;
                updateLineSelection();
                
                const stationSelect = document.getElementById('stationSelect');
                stationSelect.value = stationName;
                updateStationSelection();
                
                // Set track to track1
                const trackSelect = document.getElementById('trackSelect');
                if (trackSelect.options.length > 0) {
                    trackSelect.value = "track1";
                    updateTrackSelection();
                }
            }
        }

        function saveChanges() {
            const lineCode = document.getElementById('lineSelect')?.value;
            if (!lineCode) return;

            try {
                // Save line style
                configData.lines[lineCode].style = {
                    lineMarkerBgColor: document.getElementById('lineMarkerBgColor').value,
                    lineNumberBgColor: document.getElementById('lineNumberBgColor').value,
                    directionBarBgColor: document.getElementById('directionBarBgColor').value
                };

                const stationName = document.getElementById('stationSelect')?.value;
                const trackNumber = document.getElementById('trackSelect')?.value;
                
                if (!stationName || !trackNumber) return;

                const track = configData.lines[lineCode].stations[stationName].Trk[trackNumber];
                
                // Update track information
                track.Marker = {
                    LC: document.getElementById('trackLineCode').value,
                    sNum: document.getElementById('trackStationNumber').value
                };

                // Update audio tracks
                track.audio = {
                    melody: parseInt(document.getElementById('melodyTrack').value) || 1,
                    atos: parseInt(document.getElementById('atosTrack').value) || 1,
                    dC: parseInt(document.getElementById('doorChimeTrack').value) || 1,
                    va: parseInt(document.getElementById('vaTrack').value) || 1
                };

                track.Dir = {
                    p: {
                        Ja: document.getElementById('prevStationJa').value,
                        En: document.getElementById('prevStationEn').value
                    },
                    n: {
                        Ja: document.getElementById('nextStationJa').value,
                        En: document.getElementById('nextStationEn').value
                    }
                };

                const station = configData.lines[lineCode].stations[stationName];
                station.sInfo = {
                    sC: document.getElementById('stationCode').value,
                    Ja: document.getElementById('stationNameJa').value,
                    Hi: document.getElementById('stationNameHiragana').value,
                    Ko: document.getElementById('stationNameKo').value,
                    wB: document.getElementById('wardBox').value
                };

                updatePreview();
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes. Check console for details.');
            }
        }

        // Function to convert internal format to export format
        function prepareForExport(data) {
            const exportData = JSON.parse(JSON.stringify(data));
            
            for (const line in exportData.lines) {
                for (const station in exportData.lines[line].stations) {
                    const stationData = exportData.lines[line].stations[station];
                    
                    // Convert from internal format to export format
                    if (stationData.sInfo) {
                        stationData.i = [
                            stationData.sInfo.sC || "",
                            stationData.sInfo.Ja || "",
                            stationData.sInfo.Hi || "",
                            stationData.sInfo.Ko || "",
                            stationData.sInfo.wB || ""
                        ];
                        delete stationData.sInfo;
                    }
                    
                    if (stationData.Trk) {
                        stationData.t = [];
                        
                        // Convert each track from object to array
                        for (const trackName in stationData.Trk) {
                            const track = stationData.Trk[trackName];
                            
                            stationData.t.push([
                                trackName,
                                track.Marker?.LC || "",
                                track.Marker?.sNum || "",
                                [
                                    track.audio?.melody || 1,
                                    track.audio?.atos || 1,
                                    track.audio?.dC || 1,
                                    track.audio?.va || 1
                                ],
                                [
                                    track.Dir?.p?.Ja || "",
                                    track.Dir?.p?.En || ""
                                ],
                                [
                                    track.Dir?.n?.Ja || "",
                                    track.Dir?.n?.En || ""
                                ]
                            ]);
                        }
                        
                        delete stationData.Trk;
                    }
                }
            }
            
            return exportData;
        }

        // Function to convert import format to internal format
        function prepareForImport(data) {
            const importData = JSON.parse(JSON.stringify(data));
            
            for (const line in importData.lines) {
                for (const station in importData.lines[line].stations) {
                    const stationData = importData.lines[line].stations[station];
                    
                    // Convert from import format to internal format
                    if (stationData.i && Array.isArray(stationData.i)) {
                        stationData.sInfo = {
                            sC: stationData.i[0] || "",
                            Ja: stationData.i[1] || "",
                            Hi: stationData.i[2] || "",
                            Ko: stationData.i[3] || "",
                            wB: stationData.i[4] || ""
                        };
                        delete stationData.i;
                    }
                    
                    if (stationData.t && Array.isArray(stationData.t)) {
                        stationData.Trk = {};
                        
                        // Convert each track from array to object
                        stationData.t.forEach(track => {
                            const trackName = track[0];
                            
                            stationData.Trk[trackName] = {
                                Marker: {
                                    LC: track[1] || "",
                                    sNum: track[2] || ""
                                },
                                audio: {
                                    melody: track[3][0] || 1,
                                    atos: track[3][1] || 1,
                                    dC: track[3][2] || 1,
                                    va: track[3][3] || 1
                                },
                                Dir: {
                                    p: {
                                        Ja: track[4][0] || "",
                                        En: track[4][1] || ""
                                    },
                                    n: {
                                        Ja: track[5][0] || "",
                                        En: track[5][1] || ""
                                    }
                                }
                            };
                        });
                        
                        delete stationData.t;
                    }
                }
            }
            
            return importData;
        }

        // Update the importConfig function to handle the new format
        function importConfig(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Convert to internal format for editor compatibility
                        configData = prepareForImport(importedData);
                        
                        document.getElementById('configFilename').value = file.name;
                        initializeEditor();
                        
                        // Get first available line
                        const lineSelect = document.getElementById('lineSelect');
                        const firstLine = Object.keys(configData.lines)[0];
                        if (firstLine) {
                            lineSelect.value = firstLine;
                            updateLineSelection();
                            
                            // Get first available station
                            const stationSelect = document.getElementById('stationSelect');
                            if (stationSelect.options.length > 0) {
                                stationSelect.selectedIndex = 0;
                                updateStationSelection();
                            }
                        }
                        
                        disableInputs(false);
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                        console.error('Full error:', error);
                        console.log('Attempted to parse:', e.target.result);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }
        }

        // Update the exportConfig function to export in the new format
        function exportConfig() {
            // Convert to the export format
            const exportData = prepareForExport(configData);
            
            // Json minification function to save space
            const jsonStr = JSON.stringify(exportData, null, 1);
            const fixedStr = jsonStr.replace(/\\\\/g, '\\')
                           .replace(/\n\s+/g, '\n') // Remove extra spaces at start of lines
                           .replace(/{\n/g, '{')     // Remove newline after {
                           .replace(/\n}/g, '}')     // Remove newline before }
                           .replace(/,\n/g, ',')     // Remove newline after commas
                           .replace(/\[\n/g, '[')    // Remove newline after [
                           .replace(/\n\]/g, ']')    // Remove newline before ]
                           .replace(/": /g, '":');    // Remove space after colons
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(fixedStr);
            
            const filename = document.getElementById('configFilename').value || 'stations_config.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
        }

        function updateTrackSelection() {
            const lineCode = document.getElementById('lineSelect')?.value;
            const stationName = document.getElementById('stationSelect')?.value;
            const trackNumber = document.getElementById('trackSelect')?.value;
            
            if (!lineCode || !stationName || !trackNumber) {
                console.log('Missing required values:', { lineCode, stationName, trackNumber });
                return;
            }
            
            const track = configData.lines[lineCode]?.stations[stationName]?.Trk[trackNumber];
            if (!track) {
                console.log('Track not found:', { lineCode, stationName, trackNumber });
                return;
            }

            try {
                // Update track name edit field
                document.getElementById('trackNameEdit').value = trackNumber;

                // Use only new property names
                const lineMarker = track.Marker;
                document.getElementById('trackLineCode').value = lineMarker.LC || '';
                document.getElementById('trackStationNumber').value = lineMarker.sNum || '';

                // Update audio tracks
                if (track.audio) {
                    document.getElementById('melodyTrack').value = track.audio.melody || 1;
                    document.getElementById('atosTrack').value = track.audio.atos || 1;
                    document.getElementById('doorChimeTrack').value = track.audio.dC || 1;
                    document.getElementById('vaTrack').value = track.audio.va || 1;
                }

                // Update direction information
                // Use only new property names
                const direction = track.Dir;
                const prev = direction.p;
                const next = direction.n;
                
                document.getElementById('prevStationJa').value = prev.Ja || '';
                document.getElementById('prevStationEn').value = prev.En || '';
                document.getElementById('nextStationJa').value = next.Ja || '';
                document.getElementById('nextStationEn').value = next.En || '';

                updatePreview();
            } catch (error) {
                console.error('Error updating track selection:', error);
            }
        }

        function addNewTrack() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            if (!lineCode || !stationName) return;

            const station = configData.lines[lineCode].stations[stationName];
            if (!station.Trk) {
                station.Trk = {};
            }

            // Get all existing tracks
            const trackKeys = Object.keys(station.Trk);
            const trackCount = trackKeys.length;
            
            // Get the last track's data (if any tracks exist)
            const lastTrack = trackCount > 0 ? station.Trk[trackKeys[trackCount - 1]] : null;
            
            // Generate new track name (try to maintain naming pattern if possible)
            let newTrackName;
            if (trackCount === 0) {
                newTrackName = 'track 1';
            } else {
                // Try to extract number from last track name
                const match = trackKeys[trackCount - 1].match(/(\D*)(\d+)$/);
                if (match) {
                    // If last track had a number, increment it
                    const prefix = match[1];
                    const number = parseInt(match[2]) + 1;
                    newTrackName = `${prefix}${number}`;
                } else {
                    // If no number pattern, append number to last track name
                    newTrackName = `${trackKeys[trackCount - 1]} 2`;
                }
            }
            
            // Create new track with copied and swapped values
            station.Trk[newTrackName] = {
                Marker: {
                    LC: lastTrack ? lastTrack.Marker?.LC : lineCode,
                    sNum: lastTrack ? lastTrack.Marker?.sNum : "01"
                },
                audio: {
                    melody: lastTrack ? lastTrack.audio?.melody : 1,
                    atos: lastTrack ? lastTrack.audio?.atos : 1,
                    dC: lastTrack ? lastTrack.audio?.dC : 1,
                    va: lastTrack ? lastTrack.audio?.va : 1
                },
                Dir: {
                    // Swap previous and next station information
                    p: {
                        Ja: lastTrack ? lastTrack.Dir?.n?.Ja : "",
                        En: lastTrack ? lastTrack.Dir?.n?.En : ""
                    },
                    n: {
                        Ja: lastTrack ? lastTrack.Dir?.p?.Ja : "",
                        En: lastTrack ? lastTrack.Dir?.p?.En : ""
                    }
                }
            };
            
            updateTrackSelect();
            // Auto-select the new track
            const trackSelect = document.getElementById('trackSelect');
            trackSelect.value = newTrackName;
            updateTrackSelection();
        }

        function updateTrackSelect() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackSelect = document.getElementById('trackSelect');
            
            trackSelect.innerHTML = '';
            
            if (!lineCode || !stationName || !configData.lines[lineCode]?.stations[stationName]?.Trk) {
                trackSelect.innerHTML = '<option value="">No tracks available</option>';
                return;
            }
            
            const tracks = configData.lines[lineCode].stations[stationName].Trk;
            Object.keys(tracks).forEach(trackNumber => {
                const option = document.createElement('option');
                option.value = trackNumber;
                option.textContent = trackNumber;
                trackSelect.appendChild(option);
            });

            if (trackSelect.options.length > 0) {
                trackSelect.selectedIndex = 0;
                updateTrackSelection();
            }
        }

        // Add delete functions
        function deleteLine() {
            const lineCode = document.getElementById('lineSelect').value;
            if (!lineCode) return;
            
            if (confirm(`Are you sure you want to delete line ${lineCode}?`)) {
                delete configData.lines[lineCode];
                initializeEditor();
            }
        }

        function deleteStation() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            if (!lineCode || !stationName) return;
            
            if (confirm(`Are you sure you want to delete station ${stationName}?`)) {
                delete configData.lines[lineCode].stations[stationName];
                updateStationSelect(lineCode);
            }
        }

        function deleteTrack() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackNumber = document.getElementById('trackSelect').value;
            if (!lineCode || !stationName || !trackNumber) return;
            
            if (confirm(`Are you sure you want to delete track ${trackNumber}?`)) {
                delete configData.lines[lineCode].stations[stationName].Trk[trackNumber];
                updateTrackSelect();
            }
        }

        function updateStationName() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationSelect = document.getElementById('stationSelect');
            const oldName = stationSelect.value;
            const newName = document.getElementById('stationNameEdit').value.trim();
            
            if (!newName || !lineCode || !oldName) return;
            
            try {
                // Create copy of station data
                const stationData = configData.lines[lineCode].stations[oldName];
                // Delete old station entry
                delete configData.lines[lineCode].stations[oldName];
                // Add station with new name
                configData.lines[lineCode].stations[newName] = stationData;
                
                // Update station select
                updateStationSelect(lineCode);
                stationSelect.value = newName;
                document.getElementById('stationNameEdit').value = newName;
                updateStationSelection();
            } catch (error) {
                console.error('Error updating station name:', error);
                alert('Error updating station name');
            }
        }

        function updateTrackName() {
            const lineCode = document.getElementById('lineSelect').value;
            const stationName = document.getElementById('stationSelect').value;
            const trackSelect = document.getElementById('trackSelect');
            const oldName = trackSelect.value;
            const newName = document.getElementById('trackNameEdit').value.trim();
            
            if (!newName || !lineCode || !stationName || !oldName) return;
            
            try {
                // Create copy of track data
                const trackData = configData.lines[lineCode].stations[stationName].Trk[oldName];
                // Delete old track entry
                delete configData.lines[lineCode].stations[stationName].Trk[oldName];
                // Add track with new name
                configData.lines[lineCode].stations[stationName].Trk[newName] = trackData;
                
                // Update track select
                updateTrackSelect();
                trackSelect.value = newName;
                document.getElementById('trackNameEdit').value = newName;
                updateTrackSelection();
            } catch (error) {
                console.error('Error updating track name:', error);
                alert('Error updating track name');
            }
        }

        function navigateStation(direction) {
            const stationSelect = document.getElementById('stationSelect');
            const currentIndex = stationSelect.selectedIndex;
            
            if (direction === 'prev' && currentIndex > 0) {
                stationSelect.selectedIndex = currentIndex - 1;
            } else if (direction === 'next' && currentIndex < stationSelect.options.length - 1) {
                stationSelect.selectedIndex = currentIndex + 1;
            }
            
            updateStationSelection();
        }
    </script>
</body>
</html> 
